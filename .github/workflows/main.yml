name: Auto Update M3U

on:
  schedule:
    - cron: '0 */6 * * *' # 每 6 小时触发一次
  workflow_dispatch: # 允许手动触发

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 赋予 workflow 写入仓库内容的权限

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取所有历史记录和 tags，以便正确计算版本号

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Fetch and Process M3U File
        id: process_m3u
        run: |
          # 从 Gist 获取原始 M3U 内容并保存到临时文件
          curl -sL https://api.github.com/gists/93cf74947770066743fff7c7f4fc5820 | jq -r '.files."bj-unicom-iptv.m3u".content' > original.m3u
          
          echo "Original M3U file downloaded. Filtering for HD channels..."

          # 步骤 1: 使用 awk 过滤，只保留高清/4K频道（如果存在），或者标清频道（如果没有更高版本）
          awk '
          NR==FNR {
              if ($0 ~ /高清|4K/ && $0 ~ /#EXTINF/) {
                  name = $0;
                  sub(/.*,/, "", name);
                  sub(/高清/, "", name);
                  sub(/4K/, "", name);
                  gsub(/-/, "", name);
                  hd_channels[name] = 1;
              }
              next
          }
          {
              if ($0 ~ /^#EXTINF/) {
                  buffer = $0;
                  name = $0;
                  is_high_quality = ($0 ~ /高清|4K/);
                  sub(/.*,/, "", name);
                  sub(/高清/, "", name);
                  sub(/4K/, "", name);
                  gsub(/-/, "", name);
                  keep = is_high_quality || ! (name in hd_channels);
              } else if ($0 ~ /^rtp:/ && buffer != "") {
                  if (keep) {
                      print buffer;
                      print $0;
                  }
                  buffer = "";
                  keep = 0;
              }
          }
          ' original.m3u original.m3u > filtered.m3u

          echo "M3U file has been filtered for HD."
          echo "Now standardizing names, sorting, and processing protocols..."

          # 步骤 2: 添加 M3U 标头, 替换 "CCTV-", 排序, 并替换协议
          # - `echo "#EXTM3U"`: 写入标准的 M3U 文件头
          # - `sed 's/CCTV-/CCTV/g'`: 将 "CCTV-" 统一为 "CCTV"
          # - `paste - -`: 将 "#EXTINF" 行和其后的 rtp 地址行合并为一行，用制表符分隔，方便排序
          # - `(export LC_COLLATE=C; sort ...)`: 核心排序逻辑。LC_COLLATE=C 确保字母排在汉字前
          # - `awk ...`: 将排好序的行再拆分为两行
          # - `sed 's|rtp://...|g'`: 替换 rtp 协议为 http
          (
            echo "#EXTM3U";
            cat filtered.m3u \
              | sed 's/CCTV-/CCTV/g' \
              | paste - - \
              | (export LC_COLLATE=C; sort -t ',' -k 2) \
              | awk -F'\t' '{print $1; print $2}' \
              | sed 's|rtp://|http://192.168.1.4:8012/rtp/|g';
          ) > bj-unicom-iptv.m3u

          echo "M3U file has been fully processed and sorted."

      - name: Commit and Push Changes
        id: commit_push
        run: |
          # 检查文件是否有实际变动
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes detected. Skipping commit and release."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected. Committing and pushing..."
            git config --global user.email "action@github.com"
            git config --global user.name "GitHub Action"
            git add bj-unicom-iptv.m3u
            git commit -m "chore: Auto update bj-unicom-iptv.m3u"
            git push git@github.com:Dendim0n/home-bjunicom-iptv.git main
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Calculate Next Version
        id: versioning
        if: steps.commit_push.outputs.changed == 'true'
        run: |
          # 获取最新的 tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Current version is: $LATEST_TAG"
          
          # 计算新版本号（只增加修订号）
          NEW_TAG=$(echo $LATEST_TAG | awk -F. -v OFS=. '{$NF++; print}')
          echo "New version is: $NEW_TAG"
          
          # 将新版本号设置为输出变量
          echo "new_version=$NEW_TAG" >> "$GITHUB_OUTPUT"

      - name: Create Release
        id: create_release
        if: steps.commit_push.outputs.changed == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.versioning.outputs.new_version }}
          release_name: Release ${{ steps.versioning.outputs.new_version }}
          body: "Automated update of m3u file. Filtered for HD channels and sorted."
          draft: false
          prerelease: false

      - name: Upload Release Asset
        if: steps.commit_push.outputs.changed == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./bj-unicom-iptv.m3u
          asset_name: bj-unicom-iptv.m3u
          asset_content_type: application/x-mpegURL

