name: Auto Update M3U

on:
  schedule:
    - cron: '0 3 * * *' # 每天凌晨3点触发一次
  workflow_dispatch: # 允许手动触发

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 赋予 workflow 写入仓库内容的权限

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取所有历史记录和 tags，以便正确计算版本号

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Fetch and Process M3U File
        id: process_m3u
        run: |
          # 从 Gist 获取原始 M3U 内容并保存到临时文件
          curl -sL https://api.github.com/gists/93cf74947770066743fff7c7f4fc5820 | jq -r '.files."bj-unicom-iptv.m3u".content' > original.m3u
          
          echo "Original M3U file downloaded. Filtering for HD channels..."

          # 步骤 1: 使用 awk 过滤，只保留高清/4K频道（如果存在），或者标清频道（如果没有更高版本）
          awk '
          NR==FNR {
              if ($0 ~ /高清|4K/ && $0 ~ /#EXTINF/) {
                  name = $0;
                  sub(/.*,/, "", name);
                  sub(/高清/, "", name);
                  sub(/4K/, "", name);
                  gsub(/-/, "", name);
                  hd_channels[name] = 1;
              }
              next
          }
          {
              if ($0 ~ /^#EXTINF/) {
                  buffer = $0;
                  name = $0;
                  is_high_quality = ($0 ~ /高清|4K/);
                  sub(/.*,/, "", name);
                  sub(/高清/, "", name);
                  sub(/4K/, "", name);
                  gsub(/-/, "", name);
                  keep = is_high_quality || ! (name in hd_channels);
              } else if ($0 ~ /^rtp:/ && buffer != "") {
                  if (keep) {
                      print buffer;
                      print $0;
                  }
                  buffer = "";
                  keep = 0;
              }
          }
          ' original.m3u original.m3u > filtered.m3u

          echo "M3U file has been filtered for HD."
          echo "Now adding groups, standardizing names, sorting, and processing protocols..."

          # 步骤 2: 添加分组, 标准化名称, 排序, 并替换协议
          # 使用 awk 处理过滤后的文件，为每一对行（频道信息和地址）生成一个可排序的中间行
          # 格式为: 分组|频道名|完整的频道信息行|完整的地址行
          awk '
          {
              if ($0 ~ /^#EXTINF/) {
                  line1 = $0;
                  
                  # 统一 "CCTV-" 为 "CCTV"
                  sub(/CCTV-/, "CCTV", line1);
                  
                  # 提取频道名
                  channel_name = line1;
                  sub(/.*,/, "", channel_name);
                  
                  # 根据频道名确定分组
                  group = "其他";
                  if (channel_name ~ /^CCTV/) {
                      group = "CCTV";
                  } else if (channel_name ~ /^BRTV/) {
                      group = "BRTV";
                  }
                  
                  # 重新构建带分组信息的频道信息行
                  new_extinf = "#EXTINF:-1 group-title=\"" group "\"," channel_name;
                  
                  # 读取下一行 (rtp 地址)
                  getline line2;
                  
                  # 输出用于排序的组合行
                  print group "|" channel_name "|" new_extinf "|" line2;
              }
          }
          ' filtered.m3u > sortable.tmp

          # 对中间文件进行排序
          # - `export LC_COLLATE=C`: 确保字母排在汉字前
          # - `sort -t'|' -k1,1 -k2,2V`: 首先按分组排序，然后按频道名进行“版本排序”
          (export LC_COLLATE=C; sort -t'|' -k1,1 -k2,2V sortable.tmp) > sorted.tmp

          # 最后，从排好序的文件中提取所需内容，添加 M3U 标头，并替换协议
          (
            echo "#EXTM3U";
            awk -F'|' '{print $3; print $4}' sorted.tmp | sed 's|rtp://|http://192.168.1.4:8012/rtp/|g';
          ) > bj-unicom-iptv.m3u

          # 删除临时文件
          rm sortable.tmp sorted.tmp

          echo "M3U file has been grouped, sorted, and fully processed."

      - name: Commit and Push Changes
        id: commit_push
        run: |
          # 将可能已修改的文件添加到暂存区
          git add bj-unicom-iptv.m3u

          # 使用 git diff 检查是否有实际的内容变更。
          # 这比 `git status` 更可靠，因为它会忽略文件模式等非内容变更，
          # 从而可以防止 "nothing to commit" 错误。
          if git diff --staged --quiet; then
            echo "No content changes detected. Skipping commit and release."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Content changes detected. Committing and pushing..."
            git config --global user.email "action@github.com"
            git config --global user.name "GitHub Action"
            git commit -m "chore: Auto update bj-unicom-iptv.m3u"
            git push git@github.com:Dendim0n/home-bjunicom-iptv.git main
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Calculate Next Version
        id: versioning
        if: steps.commit_push.outputs.changed == 'true'
        run: |
          # 获取最新的 tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Current version is: $LATEST_TAG"
          
          # 计算新版本号（只增加修订号）
          NEW_TAG=$(echo $LATEST_TAG | awk -F. -v OFS=. '{$NF++; print}')
          echo "New version is: $NEW_TAG"
          
          # 将新版本号设置为输出变量
          echo "new_version=$NEW_TAG" >> "$GITHUB_OUTPUT"

      - name: Create Release
        id: create_release
        if: steps.commit_push.outputs.changed == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.versioning.outputs.new_version }}
          release_name: Release ${{ steps.versioning.outputs.new_version }}
          body: "Automated update of m3u file. Grouped, sorted, and filtered for HD channels."
          draft: false
          prerelease: false

      - name: Upload Release Asset
        if: steps.commit_push.outputs.changed == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./bj-unicom-iptv.m3u
          asset_name: bj-unicom-iptv.m3u
          asset_content_type: application/x-mpegURL

